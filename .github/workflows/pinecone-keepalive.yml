name: Pinecone Keep-Alive

on:
  schedule:
    # 매주 일요일 오전 2시 (3주 이내 활성화 유지)
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pinecone
        run: npm install @pinecone-database/pinecone

      - name: Keep index alive
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        run: |
          node -e "
          const { Pinecone } = require('@pinecone-database/pinecone');

          (async () => {
            const pc = new Pinecone({ apiKey: process.env.PINECONE_API_KEY });
            const index = pc.index('flutter-docs');

            // 간단한 쿼리로 인덱스 활성화 유지
            const dummyVector = Array(384).fill(0);
            await index.query({
              vector: dummyVector,
              topK: 1,
              includeMetadata: false,
            });

            console.log('✅ Pinecone index keep-alive successful');
          })();
          "

      - name: Log completion
        run: echo "Pinecone index remains active"
